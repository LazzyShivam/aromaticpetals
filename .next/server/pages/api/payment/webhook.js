"use strict";(()=>{var a={};a.id=4377,a.ids=[4377],a.modules={516:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>p,default:()=>o,handler:()=>n});var e=c(29046),f=c(8667),g=c(33480),h=c(86435),i=c(69110),j=c(58112),k=c(18766),l=c(61006),m=a([i]);i=(m.then?(await m)():m)[0];let o=(0,h.M)(i,"default"),p=(0,h.M)(i,"config"),q=new g.PagesAPIRouteModule({definition:{kind:f.A.PAGES_API,page:"/api/payment/webhook",pathname:"/api/payment/webhook",bundlePath:"",filename:""},userland:i,distDir:".next",relativeProjectDir:""});async function n(a,b,c){q.isDev&&(0,l.addRequestMeta)(a,"devRequestTimingInternalsEnd",process.hrtime.bigint());let d="/api/payment/webhook",f=await q.prepare(a,b,{srcPage:d});if(!f){b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve());return}let{query:g,params:h,prerenderManifest:i,routerServerContext:m}=f;try{let c=a.method||"GET",e=(0,j.getTracer)(),f=e.getActiveScopeSpan(),l=q.instrumentationOnRequestError.bind(q),n=async f=>q.render(a,b,{query:{...g,...h},params:h,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:i.preview,propagateError:!1,dev:q.isDev,page:"/api/payment/webhook",internalRevalidate:null==m?void 0:m.revalidate,onError:(...b)=>l(a,...b)}).finally(()=>{if(!f)return;f.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let a=e.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==k.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let g=a.get("next.route");if(g){let a=`${c} ${g}`;f.setAttributes({"next.route":g,"http.route":g,"next.span_name":a}),f.updateName(a)}else f.updateName(`${c} ${d}`)});f?await n(f):await e.withPropagatedContext(a.headers,()=>e.trace(k.BaseServerSpan.handleRequest,{spanName:`${c} ${d}`,kind:j.SpanKind.SERVER,attributes:{"http.method":c,"http.target":a.url}},n))}catch(a){if(q.isDev)throw a;(0,e.sendError)(b,500,"Internal Server Error")}finally{null==c.waitUntil||c.waitUntil.call(c,Promise.resolve())}}d()}catch(a){d(a)}})},69110:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{config:()=>o,default:()=>n});var e=c(77598),f=c.n(e),g=c(79037),h=a([g]);g=(h.then?(await h)():h)[0];let o={api:{bodyParser:!1}};async function i(a){let b=[];for await(let c of a)b.push(Buffer.isBuffer(c)?c:Buffer.from(c));return Buffer.concat(b)}function j(a){let b,c=(b=String(process.env.WEBHOOK_LOG_LEVEL||"").toLowerCase(),"silent"===b||"error"===b||"warn"===b||"info"===b?b:"info"),d={error:0,warn:1,info:2};return"silent"!==c&&d[a]<=d[c]}function k(a,b){j("info")&&console.info(`[razorpay-webhook] ${a}`,b??{})}function l(a,b){j("warn")&&console.warn(`[razorpay-webhook] ${a}`,b??{})}function m(a,b){j("error")&&console.error(`[razorpay-webhook] ${a}`,b??{})}async function n(a,b){let c,d,e;if("POST"!==a.method)return b.setHeader("Allow","POST"),b.status(405).json({error:"Method not allowed"});let h=process.env.RAZORPAY_WEBHOOK_SECRET;if(!h)return b.status(500).json({error:"RAZORPAY_WEBHOOK_SECRET is not configured"});let j=String(a.headers["x-razorpay-signature"]||"");if(!j)return l("Missing signature header"),b.status(400).json({error:"Missing x-razorpay-signature header"});let n=await i(a),o=f().createHmac("sha256",h).update(n).digest("hex");if(d=Buffer.from(j,"hex"),e=Buffer.from(o,"hex"),!(d.length===e.length&&f().timingSafeEqual(d,e)))return l("Invalid signature"),b.status(401).json({error:"Invalid signature"});try{c=JSON.parse(n.toString("utf8"))}catch{return l("Invalid JSON body"),b.status(400).json({error:"Invalid JSON body"})}let p="string"==typeof c?.id?c.id:null,q="string"==typeof c?.event?c.event:null,r="number"==typeof c?.created_at?new Date(1e3*c.created_at).toISOString():new Date().toISOString(),s=c?.payload?.payment?.entity,t="string"==typeof s?.id?s.id:null,u="string"==typeof s?.order_id?s.order_id:null,v="string"==typeof s?.status?s.status:null,w="number"==typeof s?.amount?s.amount:null,x="string"==typeof s?.currency?s.currency:null;if(k("Received",{eventId:p,eventType:q,paymentId:t,orderId:u,status:v,amount:w,currency:x}),!t&&!u)return k("Ignored (no payment/order ids)",{eventId:p,eventType:q}),b.status(200).json({received:!0});let y={webhook_last_event_id:p,webhook_last_event_type:q,webhook_last_event_at:r};if(v&&(y.payment_status=v),x&&(y.payment_currency=x),"number"==typeof w&&(y.payment_amount_paise=w),"captured"===v&&(y.payment_captured_at=new Date().toISOString(),y.status="confirmed"),t&&(y.razorpay_payment_id=t),u&&(y.razorpay_order_id=u),t){let{data:a,error:b}=await g.E.from("orders").update(y).eq("razorpay_payment_id",t).select("id");b?m("DB update failed (razorpay_payment_id)",{eventId:p,paymentId:t,error:b.message}):k("DB update (razorpay_payment_id)",{eventId:p,paymentId:t,updated:(a??[]).length});let{data:c,error:d}=await g.E.from("orders").update(y).eq("payment_id",t).select("id");d?m("DB update failed (payment_id)",{eventId:p,paymentId:t,error:d.message}):k("DB update (payment_id)",{eventId:p,paymentId:t,updated:(c??[]).length})}if(u){let{data:a,error:b}=await g.E.from("orders").update(y).eq("razorpay_order_id",u).select("id");b?m("DB update failed (razorpay_order_id)",{eventId:p,orderId:u,error:b.message}):k("DB update (razorpay_order_id)",{eventId:p,orderId:u,updated:(a??[]).length})}return b.status(200).json({received:!0})}d()}catch(a){d(a)}})},75600:a=>{a.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},77598:a=>{a.exports=require("node:crypto")},79037:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{E:()=>h});var e=c(93721),f=a([e]);e=(f.then?(await f)():f)[0];let g=process.env.SUPABASE_SERVICE_ROLE_KEY,h=(0,e.createClient)("https://kedjdwmxhrraztmdrgfo.supabase.co",g);d()}catch(a){d(a)}})},93721:a=>{a.exports=import("@supabase/supabase-js")}};var b=require("../../../webpack-api-runtime.js");b.C(a);var c=b.X(0,[5030],()=>b(b.s=516));module.exports=c})();