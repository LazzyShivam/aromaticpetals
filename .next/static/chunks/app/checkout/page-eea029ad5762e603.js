(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[279],{3831:(e,t,r)=>{"use strict";r.d(t,{_:()=>i});var a=r(1934),s=r(9311);let i=(0,a.v)()((0,s.Zr)((e,t)=>({items:[],mode:"local",hydrating:!1,setMode:t=>e({mode:t}),hydrateFromDb:async()=>{if("db"!==t().mode)return;e({hydrating:!0});let r=await fetch("/api/cart/list",{method:"GET",headers:{"Cache-Control":"no-cache"}}),a=await r.json().catch(()=>null);try{if(!r.ok)throw Error(a?.error||"Failed to load cart");e({items:Array.isArray(a?.items)?a.items:[]})}finally{e({hydrating:!1})}},addItem:async(r,a=1)=>{let s=Number.isFinite(a)?Math.max(1,Math.floor(a)):1;if("db"===t().mode){e(e=>e.items.find(e=>e.product_id===r.id)?{items:e.items.map(e=>e.product_id===r.id?{...e,quantity:e.quantity+s}:e)}:{items:[...e.items,{id:"pending",user_id:"",product_id:r.id,quantity:s,product:r}]});let a=await fetch("/api/cart/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:r.id,quantity:s})}),i=await a.json().catch(()=>null);if(!a.ok)throw await t().hydrateFromDb(),Error(i?.error||"Failed to add to cart");await t().hydrateFromDb();return}e(e=>e.items.find(e=>e.product_id===r.id)?{items:e.items.map(e=>e.product_id===r.id?{...e,quantity:e.quantity+s}:e)}:{items:[...e.items,{id:Math.random().toString(36).substring(7),user_id:"",product_id:r.id,quantity:s,product:r}]})},removeItem:async r=>{if("db"===t().mode){e(e=>({items:e.items.filter(e=>e.product_id!==r)}));let a=await fetch("/api/cart/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:r})}),s=await a.json().catch(()=>null);if(!a.ok)throw await t().hydrateFromDb(),Error(s?.error||"Failed to remove from cart");return}e(e=>({items:e.items.filter(e=>e.product_id!==r)}))},updateQuantity:async(r,a)=>{if("db"===t().mode){e(e=>({items:e.items.map(e=>e.product_id===r?{...e,quantity:a}:e).filter(e=>e.quantity>0)}));let s=await fetch("/api/cart/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:r,quantity:a})}),i=await s.json().catch(()=>null);if(!s.ok)throw await t().hydrateFromDb(),Error(i?.error||"Failed to update cart");return}e(e=>({items:e.items.map(e=>e.product_id===r?{...e,quantity:a}:e)}))},clearCart:async()=>{if("db"===t().mode){e({items:[]});let r=await fetch("/api/cart/clear",{method:"POST"}),a=await r.json().catch(()=>null);if(!r.ok)throw await t().hydrateFromDb(),Error(a?.error||"Failed to clear cart");return}e({items:[]})},totalItems:()=>t().items.reduce((e,t)=>e+t.quantity,0),totalPrice:()=>t().items.reduce((e,t)=>e+t.product.price*t.quantity,0)}),{name:"cart-storage"}))},5506:(e,t,r)=>{Promise.resolve().then(r.bind(r,7667))},7667:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>m});var a=r(5155),s=r(2115),i=r(3321),d=r(3831),o=r(7882),n=r(5596),l=r(5772),c=r(6296);function m(){let e=(0,i.useRouter)(),{data:t,status:r}=(0,o.useSession)(),{items:m,totalPrice:u,clearCart:x}=(0,d._)(),[h,p]=(0,s.useState)(!1),[y,g]=(0,s.useState)(""),[f,b]=(0,s.useState)(null),[j,w]=(0,s.useState)(null),[N,k]=(0,s.useState)(null),[v,_]=(0,s.useState)([]),[C,S]=(0,s.useState)(!1),[z,F]=(0,s.useState)({name:"",address:"",city:"",state:"",zip:"",phone:""}),P=N?.subtotal??u(),q=N?.discount??0,E=N?.total??u();if((0,s.useEffect)(()=>{let e=!1;return(async()=>{S(!0);try{let t=await fetch("/api/coupons/eligible",{method:"GET",headers:{"Cache-Control":"no-cache"}}),r=await t.json().catch(()=>null);if(!t.ok||e)return;_(Array.isArray(r?.coupons)?r.coupons:[])}finally{e||S(!1)}})(),()=>{e=!0}},[m]),(0,s.useEffect)(()=>{"unauthenticated"===r&&e.push("/auth/login?callbackUrl=/checkout")},[r,e]),"loading"===r||!t)return(0,a.jsx)("div",{className:"flex justify-center py-24",children:(0,a.jsx)(c.A,{className:"animate-spin h-8 w-8 text-indigo-600"})});if(0===m.length)return e.push("/cart"),null;let O=e=>{let{name:t,value:r}=e.target;F(e=>({...e,[t]:r}))},T=async r=>{r.preventDefault(),p(!0);try{let r="rzp_live_S69X3i4qEcgmMC";if(!r||r.startsWith("your-"))throw Error("Razorpay public key is not configured");let a=await fetch("/api/payment/create-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currency:"INR",receipt:`rcpt_${Date.now()}`,coupon_code:f})}),s=(a.headers.get("content-type")||"").includes("application/json")?await a.json():await a.text();if(!a.ok)throw Error("string"==typeof s?s:s.error);let i={key:r,amount:s.amount,currency:s.currency,name:"Aromatic Petals",description:"Order Payment",order_id:s.id,handler:async function(t){try{let r=await fetch("/api/orders/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({shipping_address:z,payment_id:t.razorpay_payment_id,razorpay_order_id:t.razorpay_order_id,razorpay_signature:t.razorpay_signature,coupon_code:f})});if(!r.ok){let e=(r.headers.get("content-type")||"").includes("application/json")?await r.json():await r.text();throw Error("string"==typeof e?e:e.error||"Failed to create order")}let a=await r.json().catch(()=>null);await x();let s=a?.order?.id;e.push(s?`/checkout/confirmation?order_id=${encodeURIComponent(s)}`:"/profile")}catch(e){console.error(e),alert("Payment successful but failed to create order record. Please contact support.")}},prefill:{name:z.name,email:t.user?.email,contact:z.phone},theme:{color:"#4F46E5"}};new window.Razorpay(i).open()}catch(e){console.error(e),alert(e.message||"Payment initiation failed")}finally{p(!1)}},D=async e=>{w(null);let t=e.trim();if(!t){b(null),k(null),g("");return}try{let e=await fetch("/api/coupons/apply",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({coupon_code:t})}),r=await e.json().catch(()=>null);if(!e.ok)throw Error(r?.error||"Invalid coupon");let a=String(r?.coupon?.code||t).trim();b(a),g(a),k({subtotal:r.subtotal,discount:r.discount,total:r.total})}catch(e){b(null),k(null),w(e?.message||"Invalid coupon")}},A=async()=>D(y),I=()=>{b(null),k(null),g(""),w(null)};return(0,a.jsxs)("div",{className:"bg-gray-50 dark:bg-zinc-900 min-h-screen py-12",children:[(0,a.jsx)(n.default,{src:"https://checkout.razorpay.com/v1/checkout.js"}),(0,a.jsxs)("div",{className:"mx-auto max-w-7xl px-4 sm:px-6 lg:px-8",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold tracking-tight text-gray-900 dark:text-white mb-8",children:"Checkout"}),(0,a.jsxs)("div",{className:"lg:grid lg:grid-cols-2 lg:gap-x-12 xl:gap-x-16",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Shipping Information"}),(0,a.jsxs)("form",{onSubmit:T,className:"mt-4 grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-4",children:[(0,a.jsxs)("div",{className:"sm:col-span-2",children:[(0,a.jsx)("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Full Name"}),(0,a.jsx)("div",{className:"mt-1",children:(0,a.jsx)("input",{type:"text",id:"name",name:"name",required:!0,value:z.name,onChange:O,className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"})})]}),(0,a.jsxs)("div",{className:"sm:col-span-2",children:[(0,a.jsx)("label",{htmlFor:"address",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Address"}),(0,a.jsx)("div",{className:"mt-1",children:(0,a.jsx)("input",{type:"text",id:"address",name:"address",required:!0,value:z.address,onChange:O,className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"city",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"City"}),(0,a.jsx)("div",{className:"mt-1",children:(0,a.jsx)("input",{type:"text",id:"city",name:"city",required:!0,value:z.city,onChange:O,className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"state",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"State"}),(0,a.jsx)("div",{className:"mt-1",children:(0,a.jsx)("input",{type:"text",id:"state",name:"state",required:!0,value:z.state,onChange:O,className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"zip",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"ZIP / Postal Code"}),(0,a.jsx)("div",{className:"mt-1",children:(0,a.jsx)("input",{type:"text",id:"zip",name:"zip",required:!0,value:z.zip,onChange:O,className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-700 dark:text-gray-300",children:"Phone"}),(0,a.jsx)("div",{className:"mt-1",children:(0,a.jsx)("input",{type:"tel",id:"phone",name:"phone",required:!0,value:z.phone,onChange:O,className:"block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border"})})]}),(0,a.jsx)("div",{className:"sm:col-span-2 mt-6",children:(0,a.jsx)("button",{type:"submit",disabled:h,className:"w-full rounded-md border border-transparent bg-indigo-600 px-4 py-3 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50",children:h?"Processing...":`Pay ₹${E.toFixed(2)}`})})]})]}),(0,a.jsxs)("div",{className:"mt-10 lg:mt-0",children:[(0,a.jsx)("h2",{className:"text-lg font-medium text-gray-900 dark:text-white",children:"Order Summary"}),(0,a.jsxs)("div",{className:"mt-4 rounded-lg border border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-800 shadow-sm",children:[(0,a.jsx)("ul",{role:"list",className:"divide-y divide-gray-200 dark:divide-zinc-700",children:m.map(e=>(0,a.jsxs)("li",{className:"flex py-6 px-4 sm:px-6",children:[(0,a.jsx)("div",{className:"flex-shrink-0",children:(0,a.jsx)(l.default,{src:e.product.image_url||"https://images.unsplash.com/photo-1496062031456-07b8f162a322?w=800&q=80",alt:e.product.name,width:80,height:80,className:"h-20 w-20 rounded-md object-cover object-center"})}),(0,a.jsxs)("div",{className:"ml-6 flex flex-1 flex-col",children:[(0,a.jsx)("div",{className:"flex",children:(0,a.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-700 dark:text-gray-200",children:e.product.name}),(0,a.jsx)("p",{className:"mt-1 text-sm text-gray-500 dark:text-gray-400",children:e.product.category})]})}),(0,a.jsx)("div",{className:"flex flex-1 items-end justify-between pt-2",children:(0,a.jsxs)("p",{className:"mt-1 text-sm font-medium text-gray-900 dark:text-white",children:["₹",e.product.price," x ",e.quantity]})})]})]},e.product_id))}),(0,a.jsxs)("div",{className:"border-t border-gray-200 dark:border-zinc-700 px-4 py-4 sm:px-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,a.jsx)("input",{value:y,onChange:e=>g(e.target.value.toUpperCase()),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),A())},placeholder:"Coupon code",autoCapitalize:"characters",className:"flex-1 rounded-md border border-gray-300 dark:border-zinc-700 bg-white dark:bg-zinc-900 text-gray-900 dark:text-white px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"}),f?(0,a.jsx)("button",{type:"button",onClick:I,className:"text-sm font-medium text-gray-700 hover:text-gray-900 dark:text-gray-200",children:"Remove"}):(0,a.jsx)("button",{type:"button",onClick:A,className:"text-sm font-medium text-indigo-600 hover:text-indigo-700 dark:text-indigo-400",children:"Apply"})]}),j&&(0,a.jsx)("p",{className:"mt-2 text-sm text-red-600 dark:text-red-400",children:j}),f&&!j&&(0,a.jsxs)("p",{className:"mt-2 text-sm text-green-700 dark:text-green-400",children:["Applied: ",f]}),C?(0,a.jsx)("p",{className:"mt-3 text-sm text-gray-500 dark:text-gray-400",children:"Loading available discounts…"}):v.length>0?(0,a.jsxs)("div",{className:"mt-3",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Available discounts"}),(0,a.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,a.jsxs)("button",{type:"button",onClick:I,className:`w-full text-left rounded-md border px-3 py-2 ${!f?"border-indigo-500 bg-indigo-50 dark:bg-indigo-950/30":"border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-900"}`,children:[(0,a.jsx)("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:"No coupon"}),(0,a.jsx)("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Pay full price"})]}),v.map(e=>{let t=f===e.code;return(0,a.jsx)("button",{type:"button",onClick:()=>void D(e.code),className:`w-full text-left rounded-md border px-3 py-2 ${t?"border-indigo-500 bg-indigo-50 dark:bg-indigo-950/30":"border-gray-200 dark:border-zinc-700 bg-white dark:bg-zinc-900"}`,children:(0,a.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:e.code}),e.description&&(0,a.jsx)("p",{className:"text-xs text-gray-600 dark:text-gray-400",children:e.description})]}),(0,a.jsxs)("p",{className:"text-sm font-medium text-green-700 dark:text-green-400",children:["Save ₹",Number(e.discount).toFixed(2)]})]})},e.code)})]})]}):null]}),(0,a.jsxs)("dl",{className:"border-t border-gray-200 dark:border-zinc-700 py-6 px-4 space-y-6 sm:px-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("dt",{className:"text-sm text-gray-600 dark:text-gray-300",children:"Subtotal"}),(0,a.jsxs)("dd",{className:"text-sm font-medium text-gray-900 dark:text-white",children:["₹",P.toFixed(2)]})]}),q>0&&(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("dt",{className:"text-sm text-gray-600 dark:text-gray-300",children:"Discount"}),(0,a.jsxs)("dd",{className:"text-sm font-medium text-green-700 dark:text-green-400",children:["-₹",q.toFixed(2)]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("dt",{className:"text-sm font-medium text-gray-900 dark:text-white",children:"Total"}),(0,a.jsxs)("dd",{className:"text-base font-medium text-gray-900 dark:text-white",children:["₹",E.toFixed(2)]})]})]})]})]})]})]})]})}}},e=>{e.O(0,[437,909,107,441,794,358],()=>e(e.s=5506)),_N_E=e.O()}]);